# 任务完成弹窗功能实现

## 功能概述

实现了全局任务进度轮询和任务完成弹窗功能，当任务状态变为"执行成功"或"执行失败"时，会在任何页面弹出提示窗口，显示任务执行结果和异常数量，并提供跳转到任务日志页面的功能。

## 实现架构

### 1. 全局任务进度管理 Store

**文件**: `src/stores/taskProgress.ts`

**主要功能**:
- 全局任务进度数据管理
- 任务进度轮询（每3秒一次）
- 任务状态变化检测
- 任务完成弹窗状态管理
- 异常数量获取

**核心方法**:
```typescript
// 开始轮询任务进度
startPolling()

// 检测任务状态变化
checkTaskStatusChange()

// 处理任务完成
handleTaskCompletion()

// 获取任务异常数量
getTaskAlertCount()
```

### 2. 全局任务完成弹窗组件

**文件**: `src/components/TaskCompletionDialog.vue`

**主要功能**:
- 显示任务执行结果（成功/失败）
- 显示任务名称和异常数量
- 提供"查看详情"和"关闭"按钮
- 响应式设计，支持移动端

**弹窗内容**:
- 任务名称
- 执行结果（成功/失败）
- 异常数量
- 操作按钮

### 3. 应用级集成

**文件**: `src/App.vue`

**主要功能**:
- 应用启动时自动开始任务进度轮询
- 全局弹窗组件挂载
- 应用卸载时停止轮询

### 4. 首页优化

**文件**: `src/views/Home.vue`

**主要变更**:
- 移除本地任务进度轮询
- 使用全局store的任务进度数据
- 保持原有的任务控制功能

### 5. 任务日志页面增强

**文件**: `src/views/MissionLogs.vue`

**主要功能**:
- 支持通过URL参数筛选特定任务的数据
- 当从弹窗跳转时，自动筛选对应任务的异常数据
- 动态标题显示当前筛选的任务ID

## 工作流程

### 1. 任务进度监控
```
应用启动 → 开始全局轮询 → 每3秒获取任务进度 → 检测状态变化
```

### 2. 任务完成检测
```
任务状态变化 → 检查是否从"运行"变为"完成/失败" → 获取异常数量 → 显示弹窗
```

### 3. 弹窗交互
```
用户点击"查看详情" → 跳转到任务日志页面 → 自动筛选对应任务数据
```

## API 接口

### 1. 任务进度获取
- **接口**: `/wayline/workspaces/{workspace_id}/docks/{dock_sn}/flight-tasks/progress`
- **频率**: 每3秒
- **用途**: 获取当前任务的执行进度和状态

### 2. 任务详情获取
- **接口**: `/wayline/workspaces/{workspace_id}/flight-tasks/{job_id}`
- **用途**: 获取任务的详细信息

### 3. 异常数据获取
- **接口**: `/api/v1/workspaces/{workspace_id}/vision/alerts?job_id={job_id}`
- **用途**: 获取特定任务的异常数量

## 状态管理

### 任务状态映射
```typescript
const statusMap = {
  'canceled': 'failed',
  'failed': 'failed', 
  'in_progress': 'running',
  'ok': 'completed',
  'partially_done': 'completed',
  'paused': 'paused',
  'rejected': 'failed',
  'sent': 'waiting',
  'timeout': 'failed'
}
```

### 弹窗触发条件
- 任务状态从 `'running'` 变为 `'completed'` 或 `'failed'`
- 仅在状态变化时触发，避免重复弹窗

## 用户体验优化

### 1. 全局可用性
- 在任何页面都能正确弹出
- 不受页面切换影响
- 应用重启后自动恢复轮询

### 2. 视觉设计
- 现代化弹窗设计
- 成功/失败状态区分
- 动画效果增强用户体验
- 响应式设计支持各种屏幕尺寸

### 3. 交互优化
- 一键跳转到详情页面
- 自动筛选相关数据
- 支持键盘操作（ESC关闭）

## 技术特点

### 1. 性能优化
- 全局单例轮询，避免重复请求
- 智能状态检测，减少不必要的API调用
- 组件懒加载，按需渲染

### 2. 错误处理
- API调用失败时静默处理
- 网络异常时自动重试
- 降级方案确保功能可用

### 3. 可维护性
- 模块化设计，职责分离
- TypeScript类型安全
- 详细的日志记录

## 使用说明

### 1. 自动启动
应用启动后会自动开始任务进度轮询，无需手动操作。

### 2. 弹窗触发
当任务执行完成或失败时，会自动弹出提示窗口。

### 3. 查看详情
点击"查看详情"按钮会跳转到任务日志页面，并自动筛选对应任务的数据。

### 4. 关闭弹窗
点击"关闭"按钮或按ESC键可以关闭弹窗。

## 配置选项

### 轮询间隔
```typescript
// 在 taskProgress.ts 中修改
const POLLING_INTERVAL = 3000 // 3秒
```

### 弹窗样式
```scss
// 在 TaskCompletionDialog.vue 中修改样式变量
--dialog-width: 480px;
--dialog-max-width: 90%;
```

## 扩展功能

### 1. 通知系统
可以集成浏览器通知API，在用户不在当前页面时发送通知。

### 2. 声音提醒
可以添加任务完成时的声音提醒功能。

### 3. 历史记录
可以保存任务完成历史，供用户查看。

### 4. 批量处理
可以支持多个任务同时监控和批量处理。

## 注意事项

1. **网络依赖**: 功能需要稳定的网络连接
2. **权限要求**: 需要用户登录和相应的API权限
3. **浏览器兼容**: 建议使用现代浏览器以获得最佳体验
4. **性能考虑**: 长时间运行可能消耗一定资源，已做优化处理
